name: Production CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  # Mock env vars for build validation (not for runtime)
  NEXT_PUBLIC_SUPABASE_URL: "https://mock.supabase.co"
  NEXT_PUBLIC_SUPABASE_ANON_KEY: "mock-key-for-build-validation"

jobs:
  validate:
    name: Validate Integrity & Security
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install Dependencies
        run: npm ci
        
      - name: Verify Environment Config
        run: npx ts-node src/lib/env.ts || { echo "Env Validation Failed"; exit 1; }
        env:
           NEXT_PUBLIC_SUPABASE_URL: "https://valid-url.com"
           NEXT_PUBLIC_SUPABASE_ANON_KEY: "valid-key"

      - name: Run Unit Tests
        run: npm test

      - name: Validate Content Integrity
        run: npm run validate-content
        
      - name: Generate Manifest
        run: npm run generate-manifest

      - name: Build Application
        run: npm run build
        
      - name: Security Audit
        run: npm audit --production
